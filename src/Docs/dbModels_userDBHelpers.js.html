

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: ./DBModels/userDBHelpers.js | Source: ./DBModels/userDBHelpers.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 100px; height: 100px">
        
            <a href="https://github.com/BHC-IT/dosismart" rel="noopener noreferrer" target="_blank">
                <img src="https://zupimages.net/up/20/07/hhfh.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Source: ./DBModels/userDBHelpers.js</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-./DBModels_calculsDBHelpers.html">./DBModels/calculsDBHelpers</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:./DBModels/calculsDBHelpers_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-./DBModels_calculsDBHelpers.html#~createCalcul">createCalcul</a></li><li><a href="module-./DBModels_calculsDBHelpers.html#~defaulter">defaulter</a></li><li><a href="module-./DBModels_calculsDBHelpers.html#~defaulterCalcul">defaulterCalcul</a></li><li><a href="module-./DBModels_calculsDBHelpers.html#~getCalculById">getCalculById</a></li><li><a href="module-./DBModels_calculsDBHelpers.html#~getCalculsByIds">getCalculsByIds</a></li></ul></div></li><li><a href="module-./DBModels_userDBHelpers.html">./DBModels/userDBHelpers</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:./DBModels/userDBHelpers_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-./DBModels_userDBHelpers.html#~addCaculInHistory">addCaculInHistory</a></li><li><a href="module-./DBModels_userDBHelpers.html#~checkToken">checkToken</a></li><li><a href="module-./DBModels_userDBHelpers.html#~createUser">createUser</a></li><li><a href="module-./DBModels_userDBHelpers.html#~defaulter">defaulter</a></li><li><a href="module-./DBModels_userDBHelpers.html#~defaulterUser">defaulterUser</a></li><li><a href="module-./DBModels_userDBHelpers.html#~getUserById">getUserById</a></li><li><a href="module-./DBModels_userDBHelpers.html#~updateUserById">updateUserById</a></li></ul></div></li><li><a href="module-helpers_MongoConnection.html">helpers/MongoConnection</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:helpers/MongoConnection_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-helpers_MongoConnection.html#~init">init</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#main">main</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Helpers functions to handle user with MongoDB.
 * @module ./DBModels/userDBHelpers
 */

let mongo;
let bhcAuth;
let ObjectID = require('mongodb').ObjectID;

module.exports = (mongoInited, bhcAuth_inited) => {

	mongo = mongoInited;
	bhcAuth = bhcAuth_inited;

	return {
		__defaulter: defaulter,
		__defaulterUser: defaulterUser,
		checkToken: checkToken,
		getUserById: getUserById,
		createUser: createUser,
		addCaculInHistory: addCaculInHistory,
		updateUserById: updateUserById,
		getCalculs: getCalculs,
		getCalculsIds: getCalculsIds,
		getUsersSubscribed: getUsersSubscribed,
		isSubscribed: isSubscribed
	}
}

/**
 * Used to add the properties of def into the input JSON object without erasing them.
 * @param  	{JSON} input - JSON object to edit.
 * @param  	{JSON} def - Default properties to add.
 * @throws 	Will throw an error if the argument is different than a JSON.
 * @returns {{ ...def, ...input }} 
 */
function defaulter(input, def) {
	if (typeof input !== "object" || typeof def !== "object")
		throw new Error("parameters must be JSON");
	return ({ ...def, ...input });
}

/**
 * Used to create a generic formatted JSON object for an user.
 * Add : 
 * &lt;pre class="prettyprint">&lt;code>{orga: "", history: [], subscribed: true, activated: false}&lt;/code>&lt;/pre> 
 * properties if they are not present in the input and set them to default value.
 * @param  	{JSON} input - JSON object to default.
 * @throws 	Will throw an error if the argument is different than a JSON.
 * @returns {Object} With default properties for an user : ``{orga:String, history:String[], subscribed:Boolean, activated:Boolean}``
 */
function defaulterUser(input) {
	if (typeof input !== "object")
		throw new Error("input must be JSON");
	return (defaulter(input, {
		orga: "",
		history: [],
		subscribed: true,
		activated: false
	}));
}

/**
 * Check if a token is present in the Authorization header of the HTTP request and in the right format : ``Bearer &lt;token>``.
 * @async
 * @param  {Object} req - The HTTP request object received
 * @throws Will throw an error if : 
 * - Authorization header is missing
 * - Token has a wrong format
 * - Token is invalid
 * @returns {string} Token
 */
async function checkToken(req) {
	let token = null;

	// Check that a token is in the header under Authorization
	try {
		token = req.headers.authorization.split(" ")[1];
	} catch (e) {
		throw new Error("no token or bad format in header");
	}

	// Check from bhcAuth if token is valid
	try {
		await bhcAuth.auth.verify(token);
	} catch (e) {
		throw new Error(e);
	}

	return (token);
}

/**
 * Insert an user to MongoDB in the 'users' collection.
 * @param  {string} userID - User's unique id (mongo.ObjectID).
 * @param  {Object} [userInfo={}] - User's informations.
 * @throws Will reject if : 
 * - userId is not a string
 * - userInfo is not an object
 * - Mongo insertOne failed (eg. user already exists)
 * @returns {Promise} Promise object represents the result of inserting. See {@link https://docs.mongodb.com/manual/reference/method/db.collection.insertOne/ db.collection.insertOne}.
 */
function createUser(userID, userInfo = {}) {
	let prom = new Promise((resolve, reject) => {
		if (typeof userID !== "string")
			return reject("userId must be a string");
		if (typeof userInfo !== "object")
			return reject("userInfo must be JSON");
		let input = defaulterUser(userInfo);
		if (typeof input['orga'] !== "string" || typeof input['subscribed'] !== "boolean" || typeof input['activated'] !== "boolean" || !Array.isArray(input['history']))
			return reject("bad type for parameter in JSON");
		let id = mongo.parseID(userID);
		mongo.col("users").insertOne({ _id: id, ...input }, (err, res) => {
			if (err !== null) {
				return reject(err);
			}
			resolve(res);
		});
	});
	return (prom);
}

/**
 * Get an user in the database matching userID passed as parameter.
 * @param  {string} userID - User's unique id (mongo.ObjectID).
 * @throws Will reject if : 
 * - userId is not a string
 * - Mongo findOne failed (eg. user not found)
 * @returns {Promise} Promise object represents the result of finding. 
 */
function getUserById(UserId) {
	let prom = new Promise((resolve, reject) => {
		if (typeof UserId !== "string" &amp;&amp; !(UserId instanceof ObjectID))
			return reject("UserId must be a string");
		let id = mongo.parseID(UserId);
		mongo.col("users").findOne({ _id: id }, (err, res) => {
			if (err !== null)
				return reject(err);
			if (res === null || res.length === 0)
				return reject("Could not find user with this id");
			resolve(res);
		});
	});
	return (prom);
}
/**
 * Add a calcul in the history of the user.
 * @async
 * @param  {string} userId - User's unique id (mongo.ObjectID).
 * @param  {string} calculId - Calcul's unique id (mongo.ObjectID).
 * @throws Throw an error if :
 * - Bad parameters (missing or wrong type)
 * - The calcul is already in the history of the user
 * - User with this userId does not exist
 * @returns {Promise} Returned by {@link module:./DBModels/userDBHelpers~updateUserById userDBHelpers.updateUserById()}.
 */
async function addCaculInHistory(userId, calculId) {
	if (typeof userId === "undefined" || typeof calculId === "undefined") {
		throw new Error("function must have 2 parameters");
	}
	if ((typeof userId !== "string" &amp;&amp; !(userId instanceof ObjectID)) || (typeof calculId !== "string" &amp;&amp; !(calculId instanceof ObjectID))) {
		throw new Error("ID must be a string");
	}
	try {
		let history = (await getUserById(userId)).history;
		if (history.findIndex((e) => e === calculId ? true : false) === -1) {
			history.push(calculId);
			let res = await updateUserById(userId, { history: history });
			return (res);
		}
		throw "id of calcul is already in history for this user";
	} catch (e) {
		throw e;
	}
}
/**
 * Update the informations of an user.
 * @param  {string} userId - User's unique id (mongo.ObjectID).
 * @param  {Object} userInfo - User's informations.
 * @throws Will reject if : 
 * - Bad parameter type
 * - Bad userInfo format
 * - Mongo findOneAndUpdate failed
 * - User with this id does not exist
 * @returns {Promise} Promise object represents the result of findOneAndUpdate.
 */
function updateUserById(userId, userInfo) {
	let prom = new Promise((resolve, reject) => {
		if (typeof userId !== "string" &amp;&amp; !(userId instanceof ObjectID)) {
			return reject("userId must be a string")
		}
		if (typeof userInfo !== "object") {
			return reject("userInfo must be a JSON");
		}
		if (JSON.stringify(userInfo) === JSON.stringify({})) {
			return reject("userInfo can't be empty");
		}
		if (typeof userInfo.orga !== "undefined") {
			typeof userInfo.orga !== "string" ? (() => { return reject("bad type for parameter orga in userInfo") })() : null;
		}
		if (typeof userInfo.history !== "undefined") {
			!Array.isArray(userInfo.history) ? (() => { return reject("bad type for parameter history in userInfo") })() : null;
			userInfo.history.forEach(function (calculInHistory) {
				typeof calculInHistory !== "string" &amp;&amp; !(calculInHistory instanceof ObjectID) ? (() => { return reject("bad type for content of parameter history in userInfo") })() : null;
			});
		}
		if (typeof userInfo.subscribed !== "undefined") {
			typeof userInfo.subscribed !== "boolean" ? (() => { return reject("bad type for parameter subscribed in userInfo") })() : null;
		}
		if (typeof userInfo.activated !== "undefined") {
			typeof userInfo.activated !== "boolean" ? (() => { return reject("bad type for parameter activated in userInfo") })() : null;
		}
		let id = mongo.parseID(userId);
		mongo.col("users").findOneAndUpdate({ _id: id }, { $set: { ...userInfo } }, { returnOriginal: false }, (err, res) => {
			if (err !== null)
				return reject(err);
			if (res === null || res.length === 0 || res.value === null)
				return reject("Could not modify the user with this ID");
			resolve(res);
		});
	});
	return (prom);
}

//-----------------------------------------------------------------------------------------------------------------------------------
//							!!! non testée !!!
//-----------------------------------------------------------------------------------------------------------------------------------


function getCalculsIds(userId) {
	let prom = new Promise((resolve, reject) => {
		if (typeof userId !== "string" &amp;&amp; !(userId instanceof ObjectID))
			return reject("UserId must be a string");
		let id = mongo.parseID(userId);
		mongo.col("users").findOne({ _id: id }, (err, res) => {
			if (err !== null) {
				return reject(err);
			}
			if (res === null || res.length === 0 || res.value === null) {
				return reject("Could not find calculs ids");
			}
			resolve(res.history);
		});
	});
	return (prom);
}

async function getCalculs(userId) {
	let prom = new Promise((resolve, reject) => {
		if (typeof userId !== "string" &amp;&amp; !(userId instanceof ObjectID))
			return reject("UserId must be a string");
		let id = mongo.parseID(userId);
		try {
			console.log("getCalculsIds(id)", getCalculsIds(id));
			mongo.col("calculs").find({ _id: { $in: getCalculsIds(id) } }, (err, res) => {
				if (err !== null) {
					return reject(err);
				}
				//console.log("res : ", res);
				//res.hasNext() ? console.log("res.next :", await res.next()) : console.log("res havn't next");
				if (res.hasNext()) {
					console.log("res.next :", /*await */(res.next()));
				} else {
					console.log("res havn't next");
				}
				if (res === null || res.length === 0 /*|| res.value === null*/) {
					return reject("Could not find calculs");
				}
				resolve(res);
			});
		} catch (e) {
			return reject(e);
		}
	});
	return (prom);
}


async function isSubscribed(userId) {
	if (typeof userId === "undefined") {
		throw new Error("userId can't be empty");
	}
	if (typeof userId !== "string" &amp;&amp; !(userId instanceof ObjectID)) {
		throw new Error("UserId must be a string");
	}
	let id = mongo.parseID(userId);
	let isSubscribed;
	let user;
	try {
		user = await getUserById(id);
		isSubscribed = user.subscribed;
	} catch (e) {
		throw new Error(e);
	}
	return (isSubscribed);
}

function getUsersSubscribed() {
	let prom = new Promise((resolve, reject) => {
		mongo.col("users").find({ _subsrcibed: true }, (err, res) => {
			if (err !== null) {
				return reject(err);
			}
			if (res === null || res.length === 0) {
				return reject("Could not find subscribed users");
			}
			resolve(res);
		});
	});
	return (prom);
}</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://zupimages.net/up/20/07/hhfh.png" style="width: 100px; height: 100px">
    <div class="footer-text">Dosismart BridgeJS Documentation</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>

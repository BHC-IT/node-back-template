

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: ./DBModels/calculsDBHelpers.js | Source: ./DBModels/calculsDBHelpers.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 100px; height: 100px">
        
            <a href="https://github.com/BHC-IT/dosismart" rel="noopener noreferrer" target="_blank">
                <img src="https://zupimages.net/up/20/07/hhfh.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Source: ./DBModels/calculsDBHelpers.js</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-./DBModels_calculsDBHelpers.html">./DBModels/calculsDBHelpers</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:./DBModels/calculsDBHelpers_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-./DBModels_calculsDBHelpers.html#~createCalcul">createCalcul</a></li><li><a href="module-./DBModels_calculsDBHelpers.html#~defaulter">defaulter</a></li><li><a href="module-./DBModels_calculsDBHelpers.html#~defaulterCalcul">defaulterCalcul</a></li><li><a href="module-./DBModels_calculsDBHelpers.html#~getCalculById">getCalculById</a></li><li><a href="module-./DBModels_calculsDBHelpers.html#~getCalculsByIds">getCalculsByIds</a></li></ul></div></li><li><a href="module-./DBModels_userDBHelpers.html">./DBModels/userDBHelpers</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:./DBModels/userDBHelpers_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-./DBModels_userDBHelpers.html#~addCaculInHistory">addCaculInHistory</a></li><li><a href="module-./DBModels_userDBHelpers.html#~checkToken">checkToken</a></li><li><a href="module-./DBModels_userDBHelpers.html#~createUser">createUser</a></li><li><a href="module-./DBModels_userDBHelpers.html#~defaulter">defaulter</a></li><li><a href="module-./DBModels_userDBHelpers.html#~defaulterUser">defaulterUser</a></li><li><a href="module-./DBModels_userDBHelpers.html#~getUserById">getUserById</a></li><li><a href="module-./DBModels_userDBHelpers.html#~updateUserById">updateUserById</a></li></ul></div></li><li><a href="module-helpers_MongoConnection.html">helpers/MongoConnection</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:helpers/MongoConnection_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-helpers_MongoConnection.html#~init">init</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#main">main</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Helpers functions to handle calcul with MongoDB.
 * @module ./DBModels/calculsDBHelpers
 */

let mongo;
let ObjectID = require('mongodb').ObjectID;

module.exports = mongoInited => {

	mongo = mongoInited;

	return {
		__defaulter: defaulter,
		__defaulterCalcul: defaulterCalcul,
		createCalcul: createCalcul,
		getCalculById: getCalculById,
		getCalculsByIds: getCalculsByIds
	}
}

/**
 * Used to add the properties of def into the input JSON object without erasing them.
 * @param  	{JSON} input - JSON object to edit.
 * @param  	{JSON} def - Default properties to add.
 * @throws 	Will throw an error if the argument is different than a JSON.
 * @returns {{ ...def, ...input }} 
 */
function defaulter(input, def) {
	if (typeof input !== "object" || typeof def !== "object")
		throw new Error("parameters must be JSON");
	return ({ ...def, ...input });
}

/**
 * Used to create a generic formatted JSON object for a calcul.
 * Add : 
 * &lt;pre class="prettyprint">&lt;code>{date: null, params: null, result: null}&lt;/code>&lt;/pre> 
 * properties if they are not present in the input and set them to null by default.
 * @param  	{JSON} input - JSON object to default.
 * @throws 	Will throw an error if the argument is different than a JSON.
 * @returns {Object} With default properties for a calcul : ``{date:Number, params:Object, result:Number, ...input}``
 * @example
 * let input = {foo:"bar", date: 17688748, result: 1.87};
 * console.log(defaulterCalcul(input)); // {foo:"bar", date: 17688748, params: null, result: 1.87};
 */
function defaulterCalcul(input) {
	if (typeof input !== "object")
		throw new Error("input must be JSON");
	return (defaulter(input, {
		date: null,
		params: null,
		result: null
	}));
}

/**
 * Add a calcul with calculInfo as data into the MongoDB "calculs" collection.
 * @param  {Object} calculInfo -  Calcul's parameters.
 * @param  {Number} calculInfo.date -  The executed date of the calcul. See Date.now().
 * @param  {Object} calculInfo.params -  The parameters of the calcul.
 * @param  {Number} calculInfo.result -  The result of the calcul.
 * @returns {Promise} - Promise object represents the result of inserting. See {@link https://docs.mongodb.com/manual/reference/method/db.collection.insertOne/ db.collection.insertOne}.
 * @example
 * calculDBhelper.createCalcul({ date: Date.now(), params: {wall: 1, rn: 2, activity: 10, thick: 1.5, distance: 10.2}, result: 2.7 }).then(res => {
 * 	console.log(res);
 * }).catch(e => {
 * 	console.log(e);
 * });
 */
function createCalcul(calculInfo) {
	let prom = new Promise((resolve, reject) => {
		if (typeof calculInfo !== "object")
			return reject("calculInfo must be JSON");
		if (typeof calculInfo.date !== "number" || typeof calculInfo.params !== "object" || typeof calculInfo.result !== "number")
			return reject("bad type for parameter in JSON");
		let input = defaulterCalcul(calculInfo);
		if (input.date === null || input.params === null || input.result === null)
			return reject("Bad format for calcul");
		mongo.col("calculs").insertOne({ ...input }, (err, res) => {
			if (err !== null)
				return reject(err);
			resolve(res);
		});
	});
	return (prom);
}

/**
 * Find a calcul in the collection "calculs" matching the ObjectID passed as parameter.
 * @param  {string} CalculId - Instance of ObjectID of MongoDB. 
 * @returns {Promise} Promise object represents the result of db.collection.findOne() (MongoDB).
 */
function getCalculById(CalculId) {
	let prom = new Promise((resolve, reject) => {
		if (typeof CalculId !== "string" &amp;&amp; !(CalculId instanceof ObjectID))
			return reject("CalculId must be a string");
		let id = mongo.parseID(CalculId);
		mongo.col("calculs").findOne({ _id: id }, (err, res) => {
			if (err !== null)
				return reject(err);
			if (res === null)
				return reject("Could not find calcul with this id");
			resolve(res);
		});
	});
	return (prom);
}

/**
 * Find all calculs in the collection "calculs" matching the ObjectID passed as parameter.
 * @param  {string[]} CalculIds - Array of instance of ObjectID of MongoDB. 
 * @returns {Object[]} Array of calcul object.
 */
function getCalculsByIds(CalculsIds) {
	let prom = new Promise((resolve, reject) => {
		if (!Array.isArray(CalculsIds)) {
			return reject("CalculsIds must be an array");
		}

		let calculsIdsObject = CalculsIds.map(function (id) {
			if (typeof id !== "string" &amp;&amp; !(id instanceof ObjectID)) {
				throw new Error("CalculsIds must be an array of strings");
			}
			return mongo.parseID(id);
		});
		mongo.col("calculs").find({}, {}).toArray((err, res) => {
			if (err !== null)
				return reject(err);
			if (res === null)
				return reject("Could not find calculs with those IDs");

			let result = calculsIdsObject.map(e => {
				let tmp = res.find(calcId => calcId._id.equals(e._id));
				if (tmp)
					return tmp;
			});
			//result = res.filter(calcul => calcul["_id"] === calculsIdsObject.find(calcId => calcId === calcul["_id"]));
			resolve(result);
		});
	});
	return (prom);
}</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://zupimages.net/up/20/07/hhfh.png" style="width: 100px; height: 100px">
    <div class="footer-text">Dosismart BridgeJS Documentation</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
